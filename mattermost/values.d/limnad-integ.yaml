# helm repo add mattermost https://helm.mattermost.com
# helm upgrade --install chat -n phantom mattermost/mattermost-team-edition -f mattermost/values.d/limnad.yaml -f mattermost/values.d/limnad.secret.yaml --atomic --debug

nameOverride: mattermost-integ

persistence:
  data:
    enabled: true
    size: 1Gi
    storageClass: nfs
    accessMode: ReadWriteOnce
    # existingClaim: ""
  plugins:
    enabled: false
    size: 1Gi
    storageClass: nfs
    accessMode: ReadWriteOnce
    # existingClaim: ""

ingress:
  enabled: true
  path: /
  annotations:
    acme.kubernetes.io/enable: "true"
    acme.kubernetes.io/dns: "dns_linode_v4"
    nginx.ingress.kubernetes.io/auth-url: "https://auth.limnad.kix.co.il/oauth2/auth"
    nginx.ingress.kubernetes.io/auth-signin: "https://auth.limnad.kix.co.il/oauth2/start?rd=%2Fgo%2Fmmbeta$escaped_request_uri"
    nginx.ingress.kubernetes.io/proxy-body-size: 50m
    nginx.ingress.kubernetes.io/proxy-send-timeout: "600"
    nginx.ingress.kubernetes.io/proxy-read-timeout: "600"
    nginx.ingress.kubernetes.io/proxy-buffering: "on"
    nginx.ingress.kubernetes.io/from-to-www-redirect: "true"
    nginx.ingress.kubernetes.io/server-snippet: |
      if ( $query_string = "id=xtce3qn9xpycujbptb39dqy3ur" ) {
        return 301 https://join.nix.co.il/;
      }
      if ( $cookie_MMUSERID = "" ) {
        set $nix b;
      }
      if ( $arg_redirect_to ~* "^%2Fnix" ) {
        set $nix a$nix;
      }
      if ( $nix = ab ) {
        return 302 https://nix.co.il/?kix=n&redirect_to=$arg_redirect_to;
      }
    #    nginx.ingress.kubernetes.io/configuration-snippet: |
    #      proxy_cache mattermost_cache;
    #      proxy_cache_revalidate on;
    #      proxy_cache_min_uses 2;
    #      proxy_cache_use_stale timeout;
    #      proxy_cache_lock on;
    #### To use the nginx cache you will need to set an http-snippet in the ingress-nginx configmap
    #### http-snippet: |
    ####     proxy_cache_path /var/cache/nginx levels=1:2 keys_zone=mattermost_cache:10m max_size=3g inactive=120m use_temp_path=off;
  hosts:
    - mmbeta.limnad.kix.co.il
  tls:
    - secretName: mattermost-chat-beta-kix-tls
      hosts:
        - mmbeta.limnad.kix.co.il

#route:
#  enabled: false

### If use this please disable the mysql chart by setting mysql.enable to false
externalDB:
  enabled: true
  # postgres or mysql
  externalDriverType: postgres
  #
  #  ## postgres:  "postgres://<USERNAME>:<PASSWORD>@<HOST>:5432/<DATABASE_NAME>?sslmode=disable&connect_timeout=10"
  #  ## mysql:     "<USERNAME>:<PASSWORD>@tcp(<HOST>:3306)/<DATABASE_NAME>?charset=utf8mb4,utf8&readTimeout=30s&writeTimeout=30s"
  externalConnectionString: "postgres://xxx:x@x.db:5432/mattermost?sslmode=disable&connect_timeout=10"

config:
  AnnouncementSettings:
    EnableBanner: false
    BannerText: ''
    BannerColor: '#f2a93b'
    BannerTextColor: '#333333'
    AllowBannerDismissal: true
  ServiceSettings:
    EnableSecurityFixAlert: false
    SiteURL: https://mmbeta.limnad.kix.co.il
    EnableOAuthServiceProvider: true
    EnablePostUsernameOverride: true
    EnablePostIconOverride: true
    EnableBotAccountCreation: true
    EnableUserAccessTokens: true
    EnableMultifactorAuthentication: true
    PostEditTimeLimit: 300
    ExperimentalChannelSidebarOrganization: default_off
    GoogleDeveloperKey: xxx
    EnableLocalMode: true
    EnableDeveloper: true
  TeamSettings:
    SiteName: kix chat
    MaxUsersPerTeam: 50000
    EnableTeamCreation: false
    EnableCustomBrand: true
    CustomBrandText: welcome back nix.co.il members!
    CustomDescriptionText: self hosted, independent and free
    RestrictDirectMessage: team
    EnableTeamListing: false
    EnableXToLeaveChannelsFromLHS: true
    TeammateNameDisplay: nickname_full_name
    ExperimentalEnableAutomaticReplies: true
    MaxChannelsPerTeam: 50000
    RestrictPrivateChannelManageMembers: all
    RestrictPrivateChannelDeletion: team_admin
    RestrictPublicChannelDeletion: team_admin
    RestrictTeamInvite: all
  SqlSettings:
    AtRestEncryptKey: xxx
  LogSettings:
    ConsoleLevel: DEBUG
    EnableWebhookDebugging: true
    EnableDiagnostics: true
  NotificationLogSettings:
    ConsoleLevel: INFO
  FileSettings:
    PublicLinkSalt: xxx
  EmailSettings:
    InviteSalt: xxx
    RequireEmailVerification: true
    FeedbackName: Kix Chat
    FeedbackEmail: support@kix.co.il
    FeedbackOrganization: kix
    SMTPUsername: xxx
    SMTPPassword: xxx
    SMTPServer: smtp.gmail.com
    SMTPPort: 587
    ConnectionSecurity: STARTTLS
    PushNotificationContents: full
    EnableEmailBatching: true
    UseChannelInEmailNotifications: true
  RateLimitSettings:
    Enable: true
    VaryByHeader: X-Real-IP
    PerSec: 15
    VaryByRemoteAddr: false
    VaryByUser: true
  PrivacySettings:
    ShowEmailAddress: false
    ShowFullName: false
  SupportSettings:
    TermsOfServiceLink: https://nix.co.il/nix/pl/4x6i3g7i87dgmpbwjpwk537zxo
    PrivacyPolicyLink: https://nix.co.il/nix/pl/mw54memp97f788jdztp4p8y6yc
    AboutLink: https://nix.co.il/nix/pl/cn6415d3njgjjb63z6jrese7ho
    HelpLink: https://kix.co.il/nix/channels/help
    ReportAProblemLink: https://kix.co.il/nix/channels/help
    SupportEmail: support@kix.co.il
  GitLabSettings:
    Enable: false
    Secret: xxx
    Id: xxx
    Scope: read_user
    AuthEndpoint: https://gitlab.com/oauth/authorize
    TokenEndpoint: https://gitlab.com/oauth/token
    UserApiEndpoint: https://gitlab.com/api/v4/user
  GoogleSettings:
    Enable: true
    Secret: xxx
    Id: xxx
    Scope: read_user
    AuthEndpoint: https://gitlab.com/oauth/authorize
    TokenEndpoint: https://gitlab.com/oauth/token
    UserApiEndpoint: https://gitlab.com/api/v4/user
  PluginSettings:
    EnableUploads: true
    EnableMarketplace: false
    Plugins:
      com.github.moussetc.mattermost.plugin.giphy:
        provider: tenor
        apikey: xxx
        language: en
        rating: r
        rendition: downsized
        renditiongfycat: 100pxGif
        renditiontenor: mediumgif
      com.github.matterpoll.matterpoll:
        ExperimentalUI: true
      kopanowebmeetings:
        KWMServerURL: https://kopano.kix.co.il
        KWMServerInternalURL: http://kopano-kopanowebmeeting.phantom.svc.cluster.local:8778
        StunURI: stun:stun.l.google.com:19302
        TurnURI: turn:turn.anyfirewall.com:443?transport=tcp
        TurnUsername: webrtc
        TurnSharedKey: webrtc
    PluginStates:
      mattermost-webrtc-video:
        Enable: false
      kopanowebmeetings:
        Enable: false
      il.co.nix.x:
        Enable: true
